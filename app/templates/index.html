{% extends "base.html" %}

{% block content %}
<section class="card">
  <h2>ä¸Šä¼ å‹ç¼©åŒ…</h2>
  <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
    <input type="file" name="files" accept=".zip" multiple required />
    <button type="submit"><span class="icon-dot">â¬†</span>å¼€å§‹æ•´ç†</button>
  </form>
  <p class="hint">æ”¯æŒä¸€æ¬¡ä¸Šä¼ å¤šä¸ª ZIP æ–‡ä»¶ï¼ˆä¾‹å¦‚å½“æœˆå¯¼å‡ºçš„å¤šä¸ªåˆ†å·å‹ç¼©åŒ…ï¼‰ã€‚</p>
  {% if message %}
    <p class="message">{{ message }}</p>
  {% endif %}
</section>

<section class="card">
  <h2>å·²æ•´ç†æ—¥æœŸ</h2>
  {% if days %}
    <form action="/days/clear" method="post" onsubmit="return confirm('ç¡®å®šæ‰¹é‡æ¸…ç©ºå‹¾é€‰æ—¥æœŸçš„æ•°æ®å—ï¼Ÿ');">
      <div class="batch-actions">
        <button type="button" id="select-all" class="btn-outline"><span class="icon-dot">âœ“</span>å…¨é€‰</button>
        <button type="button" id="clear-select" class="btn-outline"><span class="icon-dot">Ã—</span>æ¸…ç©ºé€‰æ‹©</button>
        <button type="submit" class="danger"><span class="icon-dot">ğŸ—‘</span>æ‰¹é‡æ¸…ç©ºé€‰ä¸­æ—¥æœŸ</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>é€‰æ‹©</th>
            <th>æ—¥æœŸ</th>
            <th>è¡Œç¨‹æ®µæ•°</th>
            <th>åˆè®¡é‡‘é¢(å…ƒ)</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
        {% for d in days %}
          {% set day_value = "%04d-%02d-%02d"|format(d.year, d.month, d.day) %}
          <tr>
            <td><input type="checkbox" name="selected_day" value="{{ day_value }}" class="day-checkbox" /></td>
            <td>{{ day_value }}</td>
            <td>{{ d.trip_count }}</td>
            <td>{{ "%.2f"|format(d.total_amount) }}</td>
            <td>
              <a href="/day/{{ d.year }}/{{ d.month }}/{{ d.day }}" class="btn btn-outline"><span class="icon-dot">ğŸ‘</span>æŸ¥çœ‹</a>
              <span> | </span>
              <a href="/download/day/{{ d.year }}/{{ d.month }}/{{ d.day }}" class="btn"><span class="icon-dot">â¬‡</span>æŒ‰æ—¥ä¸‹è½½ZIP</a>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </form>
    <script>
      (function () {
        const allBtn = document.getElementById('select-all');
        const clearBtn = document.getElementById('clear-select');
        const boxes = Array.from(document.querySelectorAll('.day-checkbox'));
        if (allBtn) {
          allBtn.addEventListener('click', () => boxes.forEach((b) => { b.checked = true; }));
        }
        if (clearBtn) {
          clearBtn.addEventListener('click', () => boxes.forEach((b) => { b.checked = false; }));
        }
      })();
    </script>
  {% else %}
    <p>æš‚æ— æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ å‹ç¼©åŒ…ã€‚</p>
  {% endif %}
</section>

<section class="card">
  <h2>ä¸Šä¼ æ–‡ä»¶ç®¡ç†</h2>
  {% if uploads %}
    <table>
      <thead>
        <tr>
          <th>ä¸Šä¼ æ—¶é—´</th>
          <th>åŸæ–‡ä»¶å</th>
          <th>çŠ¶æ€</th>
          <th>æ–°å¢è¡Œç¨‹</th>
          <th>SHA256(å‰12ä½)</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
      {% for u in uploads %}
        <tr>
          <td>{{ u.uploaded_at }}</td>
          <td>{{ u.original_name }}</td>
          <td>{{ u.status }}</td>
          <td>{{ u.trip_count or 0 }}</td>
          <td>{{ (u.sha256 or '')[:12] }}</td>
          <td>
            {% if u.status != 'deleted' and u.file_exists %}
              <a href="/uploads/{{ u.id }}/download" class="btn btn-outline"><span class="icon-dot">â¬‡</span>ä¸‹è½½æºæ–‡ä»¶</a>
              <span> | </span>
              <form action="/uploads/{{ u.id }}/delete" method="post" class="inline-form" onsubmit="return confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªä¸Šä¼ æºæ–‡ä»¶å—ï¼Ÿ');">
                <button type="submit" class="danger"><span class="icon-dot">ğŸ—‘</span>åˆ é™¤</button>
              </form>
            {% else %}
              <span>-</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>æš‚æ— ä¸Šä¼ è®°å½•ã€‚</p>
  {% endif %}
</section>
{% endblock %}
