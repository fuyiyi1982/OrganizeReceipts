{% extends "base.html" %}

{% block content %}
<section class="card">
  <h2>上传压缩包</h2>
  <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
    <input type="file" name="files" accept=".zip" multiple required />
    <button type="submit">开始整理</button>
  </form>
  <p class="hint">支持一次上传多个 ZIP 文件（例如当月导出的多个分卷压缩包）。</p>
  {% if message %}
    <p class="message">{{ message }}</p>
  {% endif %}
</section>

<section class="card">
  <h2>已整理日期</h2>
  {% if days %}
    <form action="/days/clear" method="post" onsubmit="return confirm('确定批量清空勾选日期的数据吗？');">
      <div class="batch-actions">
        <button type="button" id="select-all">全选</button>
        <button type="button" id="clear-select">清空选择</button>
        <button type="submit" class="danger">批量清空选中日期</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>选择</th>
            <th>日期</th>
            <th>行程段数</th>
            <th>合计金额(元)</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
        {% for d in days %}
          {% set day_value = "%04d-%02d-%02d"|format(d.year, d.month, d.day) %}
          <tr>
            <td><input type="checkbox" name="selected_day" value="{{ day_value }}" class="day-checkbox" /></td>
            <td>{{ day_value }}</td>
            <td>{{ d.trip_count }}</td>
            <td>{{ "%.2f"|format(d.total_amount) }}</td>
            <td>
              <a href="/day/{{ d.year }}/{{ d.month }}/{{ d.day }}">查看</a>
              <span> | </span>
              <a href="/download/day/{{ d.year }}/{{ d.month }}/{{ d.day }}">按日下载ZIP</a>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </form>
    <script>
      (function () {
        const allBtn = document.getElementById('select-all');
        const clearBtn = document.getElementById('clear-select');
        const boxes = Array.from(document.querySelectorAll('.day-checkbox'));
        if (allBtn) {
          allBtn.addEventListener('click', () => boxes.forEach((b) => { b.checked = true; }));
        }
        if (clearBtn) {
          clearBtn.addEventListener('click', () => boxes.forEach((b) => { b.checked = false; }));
        }
      })();
    </script>
  {% else %}
    <p>暂无数据，请先上传压缩包。</p>
  {% endif %}
</section>

<section class="card">
  <h2>上传文件管理</h2>
  {% if uploads %}
    <table>
      <thead>
        <tr>
          <th>上传时间</th>
          <th>原文件名</th>
          <th>状态</th>
          <th>新增行程</th>
          <th>SHA256(前12位)</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
      {% for u in uploads %}
        <tr>
          <td>{{ u.uploaded_at }}</td>
          <td>{{ u.original_name }}</td>
          <td>{{ u.status }}</td>
          <td>{{ u.trip_count or 0 }}</td>
          <td>{{ (u.sha256 or '')[:12] }}</td>
          <td>
            {% if u.status != 'deleted' and u.file_exists %}
              <a href="/uploads/{{ u.id }}/download">下载源文件</a>
              <span> | </span>
              <form action="/uploads/{{ u.id }}/delete" method="post" class="inline-form" onsubmit="return confirm('确定删除这个上传源文件吗？');">
                <button type="submit" class="danger">删除</button>
              </form>
            {% else %}
              <span>-</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>暂无上传记录。</p>
  {% endif %}
</section>
{% endblock %}
